# 网络编程

## Socket

Socket 是一个网络连接，它内部通过TCP/IP协议将数据传输到网络。

Socket、TCP 和部分 IP 的功能都是由操作系统提供的，不同的编程语言只是提供了对操作系统调用的简单的封装。

计算机仅仅通过 IP 地址进行通信是不够的，同一台计算机同一时间会有多个应用程序运行。IP地址只是在网络中定位了计算机设备的位置，数据包的正确发送还需要根据每个应用程序端口号。Socket 就是由 IP 地址和端口号组成的。通过 Socket 才能够进行不同应用程序间正确的网络传输。

>  由此可见，要实现两个进程间的通信可以通过 Socket 来实现

用 Java 中的`Socket`类编写服务端和客户端

服务端

服务端通过`ServerSocket`监听计算机指定的端口，等待客户端发送`Socket`的连接请求

服务端通过`accept`接收连接并返对应的`Socket`

Java `Socket`类中封装了输入输出流，用来进行客户端和服务端的数据传输

```java
public class Server {
    public static void main(String[] args) throws IOException {
        ServerSocket serverSocket = new ServerSocket(6666); // 监听指定端口
        // 服务端总是被动的接受客户端发送的请求，因此使用循环等待accept
        for (;;) {
            Socket socket = serverSocket.accept(); // 在没有客户端连接时阻塞
            Thread thread = new TaskThread(socket);
            thread.start();
        }
    }
}

class TaskThread extends Thread {

    private final Socket socket;

    public TaskThread(Socket socket) {
        this.socket = socket;
    }

    @Override
    public void run() {
        try (InputStream inputStream = this.socket.getInputStream();) {
            try (OutputStream outputStream = this.socket.getOutputStream();) {
                handle(inputStream, outputStream);
            }
        } catch (IOException e) {
            try {
                this.socket.close();
            } catch (IOException e1) {

            }
            System.out.println("Socket closed");
        }
    }
	
    // 用来处理输入输出流
    public void handle(InputStream inputStream, OutputStream outputStream) throws IOException {
        BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream));
        BufferedWriter writer = new BufferedWriter(new OutputStreamWriter(outputStream));
        writer.write("hello\n");
        writer.flush(); // 强制将缓冲区中的数据立即写出到底层目的地
        String line = "";
        for (;;) {
            line = reader.readLine();
            if (line.equals("bye")) {
                writer.write("bye\n");
                writer.flush();
                break;
            }
            writer.write("ok：" + line + "\n");
            writer.flush();
        }
    }
}
```

客户端

客户端使用`Socket(InetAddress, port)`像向服务器发送一个连接请求

```java
public class Client {

    public static void main(String[] args) throws IOException {
        Socket socket = new Socket("localhost", 6666);
        try (InputStream inputStream = socket.getInputStream()) {
            try (OutputStream outputStream = socket.getOutputStream()) {
                handle(inputStream, outputStream);
            }
        }
        socket.close();
        System.out.println("Client closed");
    }

    private static void handle(InputStream in, OutputStream out) throws IOException {
        BufferedReader reader = new BufferedReader(new InputStreamReader(in));
        BufferedWriter writer = new BufferedWriter(new OutputStreamWriter(out));
        Scanner scanner = new Scanner(System.in);
        System.out.println("[server] " + reader.readLine());
        String readLine = "";
        for (;;) {
            System.out.println(">>> ");
            String s = scanner.nextLine();
            writer.write(s + "\n");
            writer.flush();
            readLine = reader.readLine();
            if (readLine.equals("bye")) {
                break;
            }
            System.out.println("<<< " + readLine);
        }
    }
}
```



## HTTP 编程

HTTP是目前使用最广泛的Web应用程序使用的基础协议

在 Java 中，可以通过`HttpClient`发送一个 http 请求

```java
// 全局HttpClient:
static HttpClient httpClient = HttpClient.newBuilder().build();

public static void main(String[] args) throws Exception {
    String url = "https://blog.csdn.net/";
    HttpRequest request = HttpRequest.newBuilder(new URI(url))
            // 设置Header:
            .header("User-Agent", "Java HttpClient").header("Accept", "*/*")
            // 设置超时:
            .timeout(Duration.ofSeconds(5))
            // 设置版本:
            .version(HttpClient.Version.HTTP_2).build();
    HttpResponse<String> response = httpClient.send(request, HttpResponse.BodyHandlers.ofString());
    // HTTP允许重复的Header，因此一个Header可对应多个Value:
    Map<String, List<String>> headers = response.headers().map();
    for (String header : headers.keySet()) {
        System.out.println(header + ": " + headers.get(header).get(0));
    }
    System.out.println(response.body().substring(0, 1024));
}
```

