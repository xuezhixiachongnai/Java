# 定时任务

```java
@Configuration
@EnableScheduling // 开启定时任务
public class TaskConfig {

    @Scheduled(fixedRate = 1000) // 定义一个定时任务
    public void scheduledTask() {
        System.out.println("我永远喜欢雪之下雪乃");
    }
}
```

`@Scheduled` 中参数

`fixedRate` 固定速率，每隔一段时间执行一次

> 它的开始时间是以上一次任务的开始执行的时间为基准的，隔 x 秒再触发下一次执行
>
> **如果上一次任务还没有完成，那么在此期间可以开始新任务吗**
>
> 默认情况下，spring 的 `@Scheduled` 使用的是单线程调度器 `ThreadPoolTaskScheduler`，默认只有 1 个线程，所以即使在上一个线程还没执行完的期间，新线程也不会执行
>
> 如果要实现多线程任务调度器，需要自己配置
>
> ```java
> @Configuration
> public class TaskConfig {
>     @Bean
>     public ThreadPoolTaskScheduler taskScheduler() {
>         ThreadPoolTaskScheduler scheduler = new ThreadPoolTaskScheduler();
>         scheduler.setPoolSize(5); // 开 5 个线程
>         scheduler.setThreadNamePrefix("my-task-");
>         return scheduler;
>     }
> }
> ```
>
> 这样在任务线程池中有线程的情况下就可以实现并发

`fixedDelay` 固定延迟，任务执行完成后，延迟一定时间在执行

`cron` 配置 cron 表达式，可以精确控制时间

cron 表达式有 6~7 个字段

```sh
秒  分  时  日  月  周  [年]
```

个字段含义

| 字段 | 取值范围                | 特殊符号    |
| ---- | ----------------------- | ----------- |
| 秒   | 0-59                    | , - * /     |
| 分   | 0-59                    | , - * /     |
| 时   | 0-23                    | , - * /     |
| 日   | 1-31                    | , - * ? L W |
| 月   | 1-12 或 JAN-DEC         | , - * /     |
| 周   | 0-6（0=周日）或 SUN-SAT | , - * ? L # |
| 年   | 可选，1970-2099         | , - * /     |



```sh
* → 任意值

, → 多个值

- → 范围

/ → 步长（如 0/5 表示每 5 单位一次）

? → 日和周字段里的“占位符”，避免冲突

L → 最后（如月的最后一天，周的最后一天=周六）

W → 工作日（如 15W 表示离 15 号最近的工作日）

# → 第几个星期几（如 2#1 表示每月第一个星期一）
```

常见表达式

| 表达式                | 含义                                        |
| --------------------- | ------------------------------------------- |
| `0 0/5 * * * ?`       | 每 5 分钟执行一次                           |
| `0 0 2 * * ?`         | 每天凌晨 2 点执行                           |
| `0 0 9,18 * * ?`      | 每天上午 9 点、下午 6 点各执行一次          |
| `0 0/10 9-17 * * ?`   | 每天 9 点到 17 点之间，每隔 10 分钟执行一次 |
| `0 30 10 ? * MON-FRI` | 周一到周五，每天 10:30 执行                 |
| `0 0 0 L * ?`         | 每月最后一天的 0 点执行                     |
| `0 0 0 1 1 ?`         | 每年 1 月 1 日 0 点执行                     |
| `0 15 10 ? * 6L`      | 每月最后一个周五的 10:15 执行               |

SchedulingConfigurer 接口可以进行更复杂的定制

```java
@Configuration
@EnableScheduling
public class TaskConfig implements SchedulingConfigurer {

    @Override
    public void configureTasks(ScheduledTaskRegistrar registrar) {
        registrar.setScheduler(taskScheduler()); // 使用自定义线程池
    }

    @Bean
    public ThreadPoolTaskScheduler taskScheduler() {
        ThreadPoolTaskScheduler scheduler = new ThreadPoolTaskScheduler();
        scheduler.setPoolSize(10);  // 并发线程数
        scheduler.setThreadNamePrefix("my-scheduler-");
        scheduler.setWaitForTasksToCompleteOnShutdown(true);
        scheduler.setAwaitTerminationSeconds(30);
        return scheduler;
    }
}
```

```java
registrar.addCronTask(() -> System.out.println("Task1"), "0/5 * * * * ?"); // 注册静态任务
```

```java
registrar.addTriggerTask(
    () -> System.out.println("Dynamic Task"),
    triggerContext -> {
        String cron = getCronFromDb(); // 比如从数据库/配置中心获取
        return new CronTrigger(cron).nextExecutionTime(triggerContext);
    }
); // 注册动态任务
```

```java
registrar.addFixedRateTask(() -> System.out.println("FixedRate Task"), 5000); // 设置固定速率的定时任务
registrar.addFixedDelayTask(() -> System.out.println("FixedDelay Task"), 3000); // 设置固定间隔的定时任务
```





## Quartz

### 概述

是一款功能强大的开源任务调度框架。他有4个核心概念：

- `Job`：任务，要执行的具体内容
- `JobDetail`：任务详情，Job是它要执行的内容，同时包含了这个任务调度的策略和方案
- `Trigger`：触发器，可以通过 Cron 表达式来指定任务执行的时间
- `Scheduler`：调度器，可以注册多个 JobDetail 和 Trigger，用来调度、暂停和删除任务

### https://www.cnblogs.com/xiao2shiqi/p/17064305.html